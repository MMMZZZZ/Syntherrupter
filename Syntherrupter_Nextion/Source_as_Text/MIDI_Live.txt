Page MIDI_Live
    Events
        Preinitialize Event
            // Prevent page refreshs until postinit
            ref_stop
            //
            // Load colors
            click fLoadColors,1
            //
            // Display username
            if(User_Settings.userNum.val==0)
            {
                tUser.txt=" "+User_Settings.u0Name.txt
            }else if(User_Settings.userNum.val==1)
            {
                tUser.txt=" "+User_Settings.u1Name.txt
            }else if(User_Settings.userNum.val==2)
            {
                tUser.txt=" "+User_Settings.u2Name.txt
            }
            //
            // Entered MIDI Live Mode. MIDI Live Mode is now active
            Settings.activeModes.val=Settings.activeModes.val|2
            //
            // Display all active modes
            sys0=Settings.activeModes.val&1
            if(sys0!=0)
            {
                // Simple Mode is active
                tMSI.bco=6900
            }
            sys0=Settings.activeModes.val&2
            if(sys0!=0)
            {
                // MIDI Live Mode is active
                tMML.bco=6900
            }
            sys0=Settings.activeModes.val&4
            if(sys0!=0)
            {
                // Lightsaber Mode is active
                tMLS.bco=6900
            }
            //
            tmTCButtonHold.tim=Other_Settings.nHoldTime.val
            tmReturn.tim=Other_Settings.nHoldTime.val
            // Functions shall be invisible
            vis fSqrt,0
            vis fSlider,0
            vis fLoadColors,0
            vis fApply,0
            // Hide buttons for unavailable tesla coils
            vis bChannels,0
            vis tChannels,0
            if(TC_Settings.maxCoilCount.val<6)
            {
                vis btCoil6,0
                vis nOn6,0
                vis tus6,0
                vis tPerc6,0
                vis nDuty6,0
            }
            if(TC_Settings.maxCoilCount.val<5)
            {
                vis btCoil5,0
                vis nOn5,0
                vis tus5,0
                vis tPerc5,0
                vis nDuty5,0
            }
            if(TC_Settings.maxCoilCount.val<4)
            {
                vis btCoil4,0
                vis nOn4,0
                vis tus4,0
                vis tPerc4,0
                vis nDuty4,0
            }
            if(TC_Settings.maxCoilCount.val<3)
            {
                vis btCoil3,0
                vis nOn3,0
                vis tus3,0
                vis tPerc3,0
                vis nDuty3,0
            }
            if(TC_Settings.maxCoilCount.val<2)
            {
                // Single Coil Mode. No need to show a select option.
                vis btCoil2,0
                vis nOn2,0
                vis tus2,0
                vis tPerc2,0
                vis nDuty2,0
                vis btCoil1,0
                vis nOn1,0
                vis tus1,0
                vis tPerc1,0
                vis nDuty1,0
                vis tCoil,0
                // ... But we need a button to change the MIDI Channels
                vis bChannels,1
                vis tChannels,1
                // Make sure that the coil is active.
                btCoil1.val=1
                click btCoil1,0
            }
            // Load button state. Note: At the time of writing I didn't know that Nextion now supports bitwise operations.
            sys0=32
            sys1=TC_Settings.activeCoils.val
            if(sys1>=sys0)
            {
                btCoil6.val=1
                sys1-=sys0
            }
            sys0/=2
            if(sys1>=sys0)
            {
                btCoil5.val=1
                sys1-=sys0
            }
            sys0/=2
            if(sys1>=sys0)
            {
                btCoil4.val=1
                sys1-=sys0
            }
            sys0/=2
            if(sys1>=sys0)
            {
                btCoil3.val=1
                sys1-=sys0
            }
            sys0/=2
            if(sys1>=sys0)
            {
                btCoil2.val=1
                sys1-=sys0
            }
            sys0/=2
            if(sys1>=sys0)
            {
                btCoil1.val=1
                sys1-=sys0
            }
            // Load user's ontime and duty limit.
            if(User_Settings.userNum.val==2)
            {
                userOnLimit.val=User_Settings.u2Ontime.val
                userDutyLimit.val=User_Settings.u2Duty.val
            }else if(User_Settings.userNum.val==1)
            {
                userOnLimit.val=User_Settings.u1Ontime.val
                userDutyLimit.val=User_Settings.u1Duty.val
            }else
            {
                userOnLimit.val=User_Settings.u0Ontime.val
                userDutyLimit.val=User_Settings.u0Duty.val
            }
            // Load Ontime and Duty from variables. Note: variables take much less space than displayed elements and are therefore better as persistent (= global) variables.
            nOn.val=ontime.val
            nDuty.val=duty.val
            nOn1.val=set1.val&0xffff
            set1.val=set1.val>>16
            nDuty1.val=set1.val&0xffff
            nOn2.val=set2.val&0xffff
            set2.val=set2.val>>16
            nDuty2.val=set2.val&0xffff
            nOn3.val=set3.val&0xffff
            set3.val=set3.val>>16
            nDuty3.val=set3.val&0xffff
            nOn4.val=set4.val&0xffff
            set4.val=set4.val>>16
            nDuty4.val=set4.val&0xffff
            nOn5.val=set5.val&0xffff
            set5.val=set5.val>>16
            nDuty5.val=set5.val&0xffff
            nOn6.val=set6.val&0xffff
            set6.val=set6.val>>16
            nDuty6.val=set6.val&0xffff
            // Restore slider positions
            fSliderInput.val=sDuty.maxval
            fSliderOutput.val=userDutyLimit.val
            fSlider.val=nDuty.val
            click fSlider,0
            sDuty.val=fSlider.val
            fSliderInput.val=sOn.maxval
            fSliderOutput.val=userOnLimit.val
            fSlider.val=nOn.val
            click fSlider,0
            sOn.val=fSlider.val
            sOnOld.val=sOn.val
            sDutyOld.val=sDuty.val
            // Tell the microcontroller: Mode: Midi Live
            prints "mml",3
            //
            // Load Help Mode
            vis qrHelp,Help_Info.helpMode.val
            tempStr.txt=tTitle.txt
            showHelp.val=1
            click 0,1
            //
            // Enable page refreshs again
            ref_star
        
        Postinitialize Event
            // View current mode of applying
            Settings.applyingMode.val--
            click bMode,0
            //
            // Make sure the microcontroller is up-to-date
            click fApply,0
        
        Touch Press Event
            if(showHelp.val==0)
            {
                // Normal Operation
                if(Other_Settings.nBackOff.val!=0)
                {
                    // Default "stop" action.
                    // Send Mode Emergency Stop which turns all outputs off (but actually keeps the current mode)
                    prints "mes",3
                    // Set all ontime and duty settings of all pages to 0.
                    // First come the global variables then the local variables.
                    Simple.ontime.val=0
                    Simple.duty.val=0
                    Simple.set1.val=Simple.set1.val&0x0000ffff
                    Simple.set2.val=Simple.set2.val&0x0000ffff
                    Simple.set3.val=Simple.set3.val&0x0000ffff
                    Simple.set4.val=Simple.set4.val&0x0000ffff
                    Simple.set5.val=Simple.set5.val&0x0000ffff
                    Simple.set6.val=Simple.set6.val&0x0000ffff
                    MIDI_Live.ontime.val=0
                    MIDI_Live.duty.val=0
                    MIDI_Live.set1.val=0
                    MIDI_Live.set2.val=0
                    MIDI_Live.set3.val=0
                    MIDI_Live.set4.val=0
                    MIDI_Live.set5.val=0
                    MIDI_Live.set6.val=0
                    Lightsaber.ontime.val=0
                    Lightsaber.ontimes12.val=0
                    Lightsaber.ontimes34.val=0
                    Lightsaber.ontimes56.val=0
                    nOn.val=0
                    sOn.val=0
                    nOn1.val=0
                    nOn2.val=0
                    nOn3.val=0
                    nOn4.val=0
                    nOn5.val=0
                    nOn6.val=0
                    nDuty.val=0
                    sDuty.val=0
                    nDuty1.val=0
                    nDuty2.val=0
                    nDuty3.val=0
                    nDuty4.val=0
                    nDuty5.val=0
                    nDuty6.val=0
                }
            }else
            {
                // Show Help
                qrHelp.txt="git.io/Jkf22"
                click qrHelp,0
            }
        
        Touch Release Event
            
        Page Exit Event
            // Store Ontime and Duty in global variables. Note: variables take much less space than displayed elements and are therefore better as persistent (= global) variables.
            ontime.val=nOn.val
            duty.val=nDuty.val
            set1.val=nDuty1.val<<16
            set1.val+=nOn1.val
            set2.val=nDuty2.val<<16
            set2.val+=nOn2.val
            set3.val=nDuty3.val<<16
            set3.val+=nOn3.val
            set4.val=nDuty4.val<<16
            set4.val+=nOn4.val
            set5.val=nDuty5.val<<16
            set5.val+=nOn5.val
            set6.val=nDuty6.val<<16
            set6.val+=nOn6.val
        
    Components
        Button bChannels
            Properties
                Scope      : Local
                Caption    : "Channels | Pan"
                Max. length: 26
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil1.txt
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Basically copy paste from tmTCButtonHold
                        MIDI_TC_Set.origin.val=dp
                        covx sCoil.txt,MIDI_TC_Set.coilNum.val,0,0
                        page MIDI_TC_Set
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Text tHideBack
            Properties
                Scope       : Local
                Initial Text: " "
                Max. length : 1
            
            Events
                Touch Press Event
                    // This is just to hide the background around the sliders so that you do not turn the outputs off by accident.
                
                Touch Release Event
                    
        Text tChannels
            Properties
                Scope       : Local
                Initial Text: "Listen to:"
                Max. length : 20
            
            Events
                Touch Press Event
                    
                Touch Release Event
                    
        Text tTitle
            Properties
                Scope       : Local
                Initial Text: "MIDI Live Mode"
                Max. length : 22
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Slider sOn
            Properties
                Scope           : Local
                Initial Position: 0
                Lower End       : 0
                Upper End       : 366
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Slider minval = 0
                        // Slider maxval = SliderWidth - CursorWIdth - 1
                        // => Slider resolution equals slider "pixel" resolution
                        fSliderInput.val=sOn.maxval
                        fSliderOutput.val=userOnLimit.val
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2r"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        fSlider.val=sOn.val
                        click fSlider,1
                        // Reduce resolution according to slider range for more "consistent" steps.
                        sys0=1
                        if(fSlider.val>=10000)
                        {
                            sys0=1000
                        }else if(fSlider.val>=5000)
                        {
                            sys0=500
                        }else if(fSlider.val>=1000)
                        {
                            sys0=100
                        }else if(fSlider.val>=500)
                        {
                            sys0=50
                        }else if(fSlider.val>=100)
                        {
                            sys0=10
                        }else if(fSlider.val>=50)
                        {
                            sys0=5
                        }
                        fSlider.val/=sys0
                        fSlider.val*=sys0
                        if(nOn.val!=fSlider.val)
                        {
                            newData.val=1
                            nOn.val=fSlider.val
                        }
                        // to understand the following lines have a look at the Touch Move code.
                        // what you would actually wanna do is put the code above in touch move and perform a click event on touch move here (because your can press/release a slider, changing its value without moving it).
                        // However "click" can only execute press/release events, so it gets more complicated...
                        if(Settings.applyingMode.val>=1)
                        {
                            click fApply,0
                        }
                        // Store slider position in case of a "help touch"
                        sOnOld.val=sOn.val
                    }else
                    {
                        // Show Help
                        // Restore slider position after a "help touch"
                        sOn.val=sOnOld.val
                        click qrHelp,0
                    }
                
                Touch Move
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Prevent double data transmission on move.
                        Settings.applyingMode.val*=-1
                        click sOn,0
                        Settings.applyingMode.val*=-1
                        if(Settings.applyingMode.val==2)
                        {
                            click fApply,0
                        }
                    }
                
        Number nOn
            Properties
                Scope        : Local
                Initial Value: 9999
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Slider sDuty
            Properties
                Scope           : Local
                Initial Position: 0
                Lower End       : 0
                Upper End       : 366
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        fSliderInput.val=sDuty.maxval
                        fSliderOutput.val=userDutyLimit.val
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2o"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        fSlider.val=sDuty.val
                        click fSlider,1
                        if(nDuty.val!=fSlider.val)
                        {
                            newData.val=1
                            nDuty.val=fSlider.val
                        }
                        // to understand the following lines have a look at the Touch Move code.
                        // what you would actually wanna do is put the code above in touch move and perform a click event on touch move here (because your can press/release a slider, changing its value without moving it).
                        // However "click" can only execute press/release events, so it gets more complicated...
                        if(Settings.applyingMode.val>=1)
                        {
                            click fApply,0
                        }
                        // Store slider position in case of a "help touch"
                        sDutyOld.val=sDuty.val
                    }else
                    {
                        // Show Help
                        // Restore slider position after a "help touch"
                        sDuty.val=sDutyOld.val
                        click qrHelp,0
                    }
                
                Touch Move
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Prevent double data transmission on move.
                        Settings.applyingMode.val*=-1
                        click sDuty,0
                        Settings.applyingMode.val*=-1
                        if(Settings.applyingMode.val==2)
                        {
                            click fApply,0
                        }
                    }
                
        Text tDuty
            Properties
                Scope       : Local
                Initial Text: "Note Duty:"
                Max. length : 20
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Button bReturn
            Properties
                Scope      : Local
                Caption    : "Return"
                Max. length: 10
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // If button is hold, return without "exiting" MIDI Live mode (keep it running in background.
                        tmReturn.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2P"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        tmReturn.en=0
                        // Leaving MIDI Live Mode. Mode is now inactive
                        Settings.activeModes.val=Settings.activeModes.val^2
                        // Mode: EXit.
                        prints "mex",0
                        page Menu
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Float nDuty
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tCoil
            Properties
                Scope       : Local
                Initial Text: "Apply to:"
                Max. length : 20
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Button bApply
            Properties
                Scope      : Local
                Caption    : "Apply now"
                Max. length: 15
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        tmEE.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf26"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        click fApply,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Text tus
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Dual-state Button btCoil1
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "1"
                Max. length  : 3
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil1.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Stop and reset timer that detects long hold.
                        tmTCButtonHold.en=0
                        tmTCButtonHold.tim=Other_Settings.nHoldTime.val
                        // A coil might have been enabled, and thus does not have the currently displayed values.
                        newData.val=1
                        //  Bit 0-5 correspond to the state of the buttons btCoil1-btCoil6
                        sys0=btCoil1.val
                        sys0=btCoil2.val*2+sys0
                        sys0=btCoil3.val*4+sys0
                        sys0=btCoil4.val*8+sys0
                        sys0=btCoil5.val*16+sys0
                        sys0=btCoil6.val*32+sys0
                        // Store settings
                        TC_Settings.activeCoils.val=sys0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Dual-state Button btCoil2
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "2"
                Max. length  : 4
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil2.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        click btCoil1,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Dual-state Button btCoil3
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "3"
                Max. length  : 4
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil3.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        click btCoil1,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Dual-state Button btCoil4
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "4"
                Max. length  : 4
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil4.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        click btCoil1,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Dual-state Button btCoil5
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "5"
                Max. length  : 4
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil5.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        click btCoil1,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Dual-state Button btCoil6
            Properties
                Scope        : Local
                Initial State: 0
                Caption      : "6"
                Max. length  : 4
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        sCoil.txt=btCoil6.txt
                        tmTCButtonHold.en=1
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2K"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        click btCoil1,0
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Timer tmTCButtonHold
            Properties
                Scope      : Local
                Period [ms]: 250
                Running    : No
            
            Events
                Timer Event
                    tmTCButtonHold.en=0
                    MIDI_TC_Set.origin.val=dp
                    covx sCoil.txt,MIDI_TC_Set.coilNum.val,0,0
                    page MIDI_TC_Set
                
        Variable sCoil
            Properties
                Scope         : Local
                Type          : String
                Initial String: "0"
                Max. length   : 3
            
        Variable newData
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Variable ontime
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable duty
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Timer tmEE
            Properties
                Scope      : Local
                Period [ms]: 6000
                Running    : No
            
            Events
                Timer Event
                    openEE.val=1
                
        Variable openEE
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Button bNRPReset
            Properties
                Scope      : Local
                Caption    : "NRP Reset"
                Max. length: 10
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/Jkf2i"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // Return format: 'd', data byte 1, 2, 3, 4, 5
                        // Data byte 1:
                        //   Bits 0-5: coils to which settings apply. (not used here)
                        //   Bits 6-7: Mode
                        //     0 = Settings Change (not used here)
                        //     1 = NRP Reset
                        //     2 = unused
                        //     3 = Volume change (not used here)
                        // Data byte 2-5: not used here.
                        prints "d",0
                        prints 0x7f,1
                        prints 0xffffffff,4
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Variable set1
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable set2
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable set3
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable set4
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable set5
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Variable set6
            Properties
                Scope         : Global
                Type          : int32
                Initial Value : 0
            
        Number fSlider
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // fXxxx are functions. Since they need to be clicked to execute their code they need to be on the same page. Usage:
                    // 1. set the component value (fXxx.val) to the input value
                    // 2. Execute code with "click fXxxx,1".
                    // 3. Read the result from the component value (fXxx.val)
                    //
                    // Touch Press: g = o * f(x / i) with f(x) = (x^2 + x) / 2, i: input range, o: output range. => g = (x^2 + i * x) * o / (2 * i^2)
                    // Touch Release: g^-1 = ( sqrt( ( x * 8 + o ) * o ) - o ) * i / ( 2 * o )
                    //
                    sys0=fSlider.val
                    fSlider.val=sys0*sys0
                    sys0*=fSliderInput.val
                    fSlider.val+=sys0
                    fSlider.val*=fSliderOutput.val
                    sys0=2*fSliderInput.val*fSliderInput.val
                    fSlider.val/=sys0
                
                Touch Release Event
                    // fXxxx are functions. Since they need to be clicked to execute their code they need to be on the same page. Usage:
                    // 1. set the component value (fXxx.val) to the input value
                    // 2. Execute code with "click fXxxx,1".
                    // 3. Read the result from the component value (fXxx.val)
                    //
                    // Touch Press: g = o * f(x / i) with f(x) = (x^2 + x) / 2, i: input range, o: output range. => g = (x^2 + i * x) * o / (2 * i^2)
                    // Touch Release: g^-1 = ( sqrt( ( x * 8 + o ) * o ) - o ) * i / ( 2 * o )
                    //
                    fSqrt.val=fSlider.val*8
                    fSqrt.val+=fSliderOutput.val
                    fSqrt.val*=fSliderOutput.val
                    click fSqrt,1
                    fSqrt.val-=fSliderOutput.val
                    fSqrt.val*=fSliderInput.val
                    sys0=2*fSliderOutput.val
                    fSlider.val=fSqrt.val/sys0
                
        Variable fSliderInput
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Variable fSliderOutput
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Variable userOnLimit
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Variable userDutyLimit
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Number fSqrt
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // fXxxx are functions. Since they need to be clicked to execute their code they need to be on the same page. Usage:
                    // 1. set the component value (fXxx.val) to the input value
                    // 2. Execute code with "click fXxxx,1".
                    // 3. Read the result from the component value (fXxx.val)
                    // This functions calculates the square root. Source: https://en.wikipedia.org/wiki/Methods_of_computing_square_roots#Binary_numeral_system_(base_2)
                    sys0=0
                    sys1=1
                    while(sys1<=fSqrt.val)
                    {
                        sys1=sys1<<2
                    }
                    sys1=sys1>>2
                    while(sys1!=0)
                    {
                        sys2=sys0+sys1
                        if(fSqrt.val>=sys2)
                        {
                            fSqrt.val-=sys2
                            sys0=sys0>>1
                            sys0+=sys1
                        }else
                        {
                            sys0=sys0>>1
                        }
                        sys1=sys1>>2
                    }
                    fSqrt.val=sys0
                
                Touch Release Event
                    
        Text tOn
            Properties
                Scope       : Local
                Initial Text: "Note Ontime:"
                Max. length : 20
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Timer tmReturn
            Properties
                Scope      : Local
                Period [ms]: 250
                Running    : No
            
            Events
                Timer Event
                    tmReturn.en=0
                    // Leave page but keep MIDI Live Mode active in background.
                    page Menu
                
        Text tUser
            Properties
                Scope       : Local
                Initial Text: " Guest"
                Max. length : 32
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tMSI
            Properties
                Scope       : Local
                Initial Text: "Simple"
                Max. length : 16
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tMML
            Properties
                Scope       : Local
                Initial Text: "MIDI Live"
                Max. length : 16
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tMLS
            Properties
                Scope       : Local
                Initial Text: "Lightsaber"
                Max. length : 16
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn1
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus1
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn2
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus2
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn3
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus3
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn4
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus4
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn5
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus5
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Number nOn6
            Properties
                Scope        : Local
                Initial Value: 0
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tus6
            Properties
                Scope       : Local
                Initial Text: "탎"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc6
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc1
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc2
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc3
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc5
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Text tPerc4
            Properties
                Scope       : Local
                Initial Text: "%"
                Max. length : 2
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty1
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty2
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty3
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty4
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty5
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Float nDuty6
            Properties
                Scope           : Local
                Initial Value   : 0
                Divide by [10^x]: 1
            
            Events
                Touch Press Event
                    // Make this object "transparent" for clicks and click background.
                    click 0,1
                
                Touch Release Event
                    
        Variable tempStr
            Properties
                Scope         : Local
                Type          : String
                Initial String: ""
                Max. length   : 32
            
        Variable showHelp
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Hotspot fApply
            Events
                Touch Press Event
                    // Changes all page components according to the current color set.
                    // Note: This component has to be the last component of the page.
                    //
                    // sys0: component id
                    // sys1: component type
                    // sys2: picture id offset for current color mode
                    sys2=Settings.colorMode.val*Settings.picCount.val
                    for(sys0=0;sys0<fLoadColors.id;sys0++)
                    {
                        // More convenient for typing
                        sys1=b[sys0].type
                        if(sys1==121)
                        {
                            // Types that have bco
                            // page
                            if(b[sys0].bco!=Settings.backCol2.val)
                            {
                                b[sys0].bco=Settings.backCol.val
                            }
                        }else if(sys1==54||sys1==59||sys1==116||sys1==55)
                        {
                            // Types that have bco, pco, and sta:
                            // number, float, text, scroll text
                            if(b[sys0].sta==1)
                            {
                                if(b[sys0].bco!=Settings.backCol2.val)
                                {
                                    b[sys0].bco=Settings.backCol.val
                                    b[sys0].pco=Settings.frontCol.val
                                }else
                                {
                                    b[sys0].pco=Settings.frontCol2.val
                                }
                            }
                        }else if(sys1==98||sys1==53)
                        {
                            // Types that have pco, pic, pco2, pic2, sta:
                            // button, dual-state button
                            if(b[sys0].sta==2)
                            {
                                b[sys0].pco=Settings.frontCol.val
                                b[sys0].pco2=Settings.backCol.val
                                b[sys0].pic=b[sys0].pic%Settings.picCount.val
                                b[sys0].pic+=sys2
                                b[sys0].pic2=b[sys0].pic+1
                            }
                        }else if(sys1==58)
                        {
                            // Types that have bco, pco
                            // QR Code
                            b[sys0].bco=Settings.backCol.val
                            b[sys0].pco=Settings.qrFrontCol.val
                        }else if(sys1==1)
                        {
                            // Types that have pic, pic2:
                            // slider
                            b[sys0].pic=b[sys0].pic%Settings.picCount.val
                            b[sys0].pic+=sys2
                            b[sys0].pic2=b[sys0].pic2%Settings.picCount.val
                            b[sys0].pic2+=sys2
                        }
                    }
                
                Touch Release Event
                    // Return format: 'd', data byte 1, 2, 3, 4, 5
                    // Data byte 1:
                    //   Bits 0-5: coils to which settings apply.
                    //   Bits 6-7: Mode
                    //     0 = Settings Change (not used here)
                    //     1 = NRP Reset (not used here)
                    //     2 = unused
                    //     3 = Volume change
                    // Data byte 2: ontime[us] lower byte
                    // Data byte 3: ontime[us] upper byte
                    // Data byte 4: duty[1/1000] lower byte
                    // Data byte 5: duty[1/1000] upper byte
                    sys0=newData.val*TC_Settings.activeCoils.val
                    if(sys0>0)
                    {
                        if(btCoil1.val==1)
                        {
                            nOn1.val=nOn.val
                            nDuty1.val=nDuty.val
                        }
                        if(btCoil2.val==1)
                        {
                            nOn2.val=nOn.val
                            nDuty2.val=nDuty.val
                        }
                        if(btCoil3.val==1)
                        {
                            nOn3.val=nOn.val
                            nDuty3.val=nDuty.val
                        }
                        if(btCoil4.val==1)
                        {
                            nOn4.val=nOn.val
                            nDuty4.val=nDuty.val
                        }
                        if(btCoil5.val==1)
                        {
                            nOn5.val=nOn.val
                            nDuty5.val=nDuty.val
                        }
                        if(btCoil6.val==1)
                        {
                            nOn6.val=nOn.val
                            nDuty6.val=nDuty.val
                        }
                        // shift bits for volume mode
                        sys1=3<<6
                        // Add which coils are affected
                        sys1+=TC_Settings.activeCoils.val
                        // sys2 contains ontime and duty data.
                        sys2=0
                        sys2=nDuty.val
                        sys2=sys2<<16
                        sys2+=nOn.val
                        prints "d",0
                        prints sys1,1
                        prints sys2,4
                        newData.val=0
                    }
                    //
                    tmEE.en=0
                    if(openEE.val!=0)
                    {
                        openEE.val=0
                        // Important date! (DDMMYYYY)
                        sys0=11102161
                        prints "c",0
                        prints sys0,3
                    }
                
        Button bMode
            Properties
                Scope      : Local
                Caption    : "Manually"
                Max. length: 15
            
            Events
                Touch Press Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                    }else
                    {
                        // Show Help
                        qrHelp.txt="git.io/JkfaL"
                    }
                
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        // Normal operation
                        // WORKAROUND. Hiding a component when the page background color changed doesnt work properly.
                        // ref 0 takes to long, ref component doesnt work. hence: manually draw a rectangle of the right color in this area
                        // and disable the components touch events.
                        Settings.applyingMode.val++
                        if(Settings.applyingMode.val==2)
                        {
                            bMode.txt="Immediately"
                            // Manually hide Apply button. "vis xxx,0" causes flickering.
                            fill bApply.x,bApply.y,bApply.w,bApply.h,b[0].bco
                            tsw bApply,0
                        }else if(Settings.applyingMode.val==1)
                        {
                            bMode.txt="On Release"
                            // Manually hide Apply button. "vis xxx,0" causes flickering.
                            fill bApply.x,bApply.y,bApply.w,bApply.h,b[0].bco
                            tsw bApply,0
                        }else // higher than allowed, jump back to 0
                        {
                            Settings.applyingMode.val=0
                            bMode.txt="Manually"
                            // Manually show Apply button. "vis xxx,0" causes flickering.
                            ref bApply
                            tsw bApply,1
                        }
                    }else
                    {
                        // Show Help
                        click qrHelp,0
                    }
                
        Variable sOnOld
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        Variable sDutyOld
            Properties
                Scope         : Local
                Type          : int32
                Initial Value : 0
            
        QRCode qrHelp
            Properties
                Scope       : Local
                Initial Text: "git.io/JkvOK"
                Max. length : 16
            
            Events
                Touch Press Event
                    
                Touch Release Event
                    if(showHelp.val==0)
                    {
                        showHelp.val=1
                        tempStr.txt=tTitle.txt
                        tTitle.txt="Get Help/Link for..."
                        // keep QR code on top
                        ref qrHelp
                        // Show modified title before stopping screen refreshs.
                        doevents
                        ref_stop
                    }else
                    {
                        showHelp.val=0
                        tTitle.txt=tempStr.txt
                        // keep QR code on top
                        ref qrHelp
                        ref_star
                    }
                
        Hotspot fLoadColors
            Events
                Touch Press Event
                    // Changes all page components according to the current color set.
                    // Note: This component has to be the last component of the page.
                    //
                    // sys0: component id
                    // sys1: component type
                    // sys2: picture id offset for current color mode
                    sys2=Settings.colorMode.val*Settings.picCount.val
                    for(sys0=0;sys0<fLoadColors.id;sys0++)
                    {
                        // More convenient for typing
                        sys1=b[sys0].type
                        if(sys1==121)
                        {
                            // Types that have bco
                            // page
                            if(b[sys0].bco!=Settings.backCol2.val)
                            {
                                b[sys0].bco=Settings.backCol.val
                            }
                        }else if(sys1==54||sys1==59||sys1==116||sys1==55)
                        {
                            // Types that have bco, pco, and sta:
                            // number, float, text, scroll text
                            if(b[sys0].sta==1)
                            {
                                if(b[sys0].bco!=Settings.backCol2.val)
                                {
                                    b[sys0].bco=Settings.backCol.val
                                    b[sys0].pco=Settings.frontCol.val
                                }else
                                {
                                    b[sys0].pco=Settings.frontCol2.val
                                }
                            }
                        }else if(sys1==98||sys1==53)
                        {
                            // Types that have pco, pic, pco2, pic2, sta:
                            // button, dual-state button
                            if(b[sys0].sta==2)
                            {
                                b[sys0].pco=Settings.frontCol.val
                                b[sys0].pco2=Settings.backCol.val
                                b[sys0].pic=b[sys0].pic%Settings.picCount.val
                                b[sys0].pic+=sys2
                                b[sys0].pic2=b[sys0].pic+1
                            }
                        }else if(sys1==58)
                        {
                            // Types that have bco, pco
                            // QR Code
                            b[sys0].bco=Settings.backCol.val
                            b[sys0].pco=Settings.qrFrontCol.val
                        }else if(sys1==1)
                        {
                            // Types that have pic, pic2:
                            // slider
                            b[sys0].pic=b[sys0].pic%Settings.picCount.val
                            b[sys0].pic+=sys2
                            b[sys0].pic2=b[sys0].pic2%Settings.picCount.val
                            b[sys0].pic2+=sys2
                        }
                    }
                
                Touch Release Event
                    
